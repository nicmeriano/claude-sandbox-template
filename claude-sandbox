#!/usr/bin/env bash
set -euo pipefail

FRESH=false
PROJECT_DIR=""

for arg in "$@"; do
  case "$arg" in
    --fresh) FRESH=true ;;
    *) PROJECT_DIR="$arg" ;;
  esac
done

PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
PROJECT_DIR="$(cd "$PROJECT_DIR" && pwd)"

# Sync config from ~/.claude/ and build image
"$HOME/.claude-sandbox/rebuild.sh"

# State file: stores sandbox ID per workspace
STATE_DIR="$HOME/.claude-sandbox/sandboxes"
mkdir -p "$STATE_DIR"
STATE_FILE="$STATE_DIR/$(echo -n "$PROJECT_DIR" | shasum -a 256 | cut -c1-16)"

# Try to reuse existing sandbox
SANDBOX_ID=""
if [ -f "$STATE_FILE" ]; then
  SANDBOX_ID=$(cat "$STATE_FILE")
  # Verify it's still alive
  if ! docker exec "$SANDBOX_ID" true 2>/dev/null; then
    SANDBOX_ID=""
    rm -f "$STATE_FILE"
  fi
fi

# Force-recreate if --fresh
if [ "$FRESH" = true ] && [ -n "$SANDBOX_ID" ]; then
  docker sandbox rm "$SANDBOX_ID" >/dev/null 2>&1 || true
  SANDBOX_ID=""
  rm -f "$STATE_FILE"
fi

# Create new sandbox if needed
if [ -z "$SANDBOX_ID" ]; then
  SANDBOX_ID=$(docker sandbox run -d -t my-sandbox -w "$PROJECT_DIR" claude)
  echo "$SANDBOX_ID" > "$STATE_FILE"
fi

# Fix settings.json (sandbox overwrites it with a dead symlink)
docker exec -u root "$SANDBOX_ID" /opt/inject-config.sh

# Launch Claude interactively
docker exec -it "$SANDBOX_ID" claude --dangerously-skip-permissions
