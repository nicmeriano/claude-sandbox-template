#!/usr/bin/env bash
set -euo pipefail

FRESH=false
PROJECT_DIR=""

for arg in "$@"; do
  case "$arg" in
    --fresh) FRESH=true ;;
    *) PROJECT_DIR="$arg" ;;
  esac
done

PROJECT_DIR="${PROJECT_DIR:-$(pwd)}"
PROJECT_DIR="$(cd "$PROJECT_DIR" && pwd)"

# Sync config from ~/.claude/ and build image
"$HOME/.claude-sandbox/rebuild.sh"

# Deterministic sandbox name from workspace path
SANDBOX_NAME="claude-$(echo -n "$PROJECT_DIR" | shasum -a 256 | cut -c1-12)"

# Force-recreate if --fresh
if [ "$FRESH" = true ]; then
  docker sandbox rm "$SANDBOX_NAME" 2>/dev/null || true
fi

# Create sandbox if it doesn't exist (no-op if already running)
if ! docker sandbox ls 2>/dev/null | grep -q "$SANDBOX_NAME"; then
  docker sandbox create --load-local-template -t my-sandbox --name "$SANDBOX_NAME" claude "$PROJECT_DIR"
fi

# Fix settings.json (sandbox overwrites it with a dead symlink)
docker sandbox exec -u root "$SANDBOX_NAME" /opt/inject-config.sh

# Launch Claude interactively
docker sandbox run "$SANDBOX_NAME"
